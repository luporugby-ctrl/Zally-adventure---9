<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zally's Prompt Hoops: Clear Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        body {
            background-color: #f0f0f0; /* Sfondo pagina chiaro */
            color: #333;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 960px;
            height: 640px;
            background: #fff;
            border: 10px solid #ff6900; /* Zalando Orange */
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        canvas { display: block; }

        /* UI HUD OVERLAY */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
        }

        .score-box {
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #eee;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .score-label { font-size: 12px; color: #888; font-weight: bold; letter-spacing: 1px; }
        .score-val { font-size: 32px; color: #ff6900; font-weight: 900; line-height: 1; }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); /* Sfondo bianco semitrasparente */
            z-index: 100;
            pointer-events: auto;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-card {
            background: #fff;
            width: 600px;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            border: 1px solid #eee;
        }

        .modal-title {
            font-size: 48px;
            font-weight: 900;
            color: #ff6900;
            margin: 0 0 10px 0;
            text-transform: uppercase;
        }

        .modal-desc {
            font-size: 18px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .tutorial-box {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            margin-bottom: 30px;
            border-left: 5px solid #ff6900;
        }

        .tutorial-step {
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .key-badge {
            background: #333;
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn-start {
            background: #ff6900;
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, background 0.1s;
            box-shadow: 0 5px 15px rgba(255, 105, 0, 0.3);
        }
        .btn-start:hover { transform: scale(1.05); background: #e65c00; }

        /* Level Up Card Style */
        .code-block {
            background: #2d2d2d;
            color: #4ade80;
            font-family: monospace;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            margin: 20px 0;
            font-size: 14px;
            white-space: pre-wrap;
        }

    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="960" height="640"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="score-box">
                <div class="score-label">SCORE</div>
                <div class="score-val" id="scoreEl">0</div>
            </div>
            <div class="score-box">
                <div class="score-label">LEVEL</div>
                <div class="score-val" id="levelEl" style="color:#333">1/4</div>
            </div>
        </div>
    </div>

    <div id="startModal" class="modal-overlay" style="display: flex;">
        <div class="modal-card">
            <h1 class="modal-title">ZALLY'S HOOPS</h1>
            <p class="modal-desc">Impara a fare centro con i tuoi Prompt.<br>Niente trucchi, solo tecnica.</p>
            
            <div class="tutorial-box">
                <div class="tutorial-step"><span class="key-badge">SPACE</span> 1. AVVIA MIRA</div>
                <div class="tutorial-step"><span class="key-badge">SPACE</span> 2. BLOCCA & CARICA</div>
                <div class="tutorial-step"><span class="key-badge">SPACE</span> 3. TIRA!</div>
            </div>

            <button class="btn-start" onclick="game.startLevel(0)">SCENDI IN CAMPO</button>
        </div>
    </div>

    <div id="levelModal" class="modal-overlay">
        <div class="modal-card">
            <h1 class="modal-title">SWISH! üèÄ</h1>
            <h3 style="color:#333; margin-top:0;" id="lvl-tech">TECNICA SBLOCCATA</h3>
            
            <p class="modal-desc" id="lvl-desc">Descrizione...</p>
            <div class="code-block" id="lvl-code">Esempio...</div>

            <button class="btn-start" onclick="game.nextLevel()">PROSSIMO LIVELLO</button>
        </div>
    </div>
</div>

<script>
/**
 * ZALLY'S HOOPS - CLEAN EDITION
 * Focus: Visibility, Reliable Input, Clear Learning
 */

// --- CONFIG ---
const COLORS = {
    sky: '#e0f7fa',      // Azzurro chiaro giorno
    floor: '#e5e5e5',    // Cemento chiaro
    floorLines: '#ff6900',
    hoop: '#ff6900',
    ball: '#ff6900',
    text: '#333333'
};

// --- GAME ENGINE ---
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = 960;
        this.height = 640;
        
        // Asset Image (con fallback)
        this.zallyImg = new Image();
        this.zallyImg.src = 'zally-basket.png';
        this.imgLoaded = false;
        this.zallyImg.onload = () => { this.imgLoaded = true; };

        // Game State
        this.state = 'MENU'; // MENU, IDLE, AIM, POWER, FLIGHT, REPLAY
        this.levelIdx = 0;
        this.score = 0;
        this.shotsMade = 0;

        // Physics Entities
        this.ball = { x:0, y:0, vx:0, vy:0, r:16, active:false };
        this.hoop = { x:800, y:280 };
        this.player = { x:100, y:500 };

        // Input Variables
        this.angle = 45;
        this.angleDir = 0.8; 
        this.power = 0;
        this.powerDir = 1.5;

        // Environment
        this.wind = 0;
        this.particles = [];

        // Levels Data
        this.levels = [
            {
                name: "FEW-SHOT PROMPTING",
                req: 1, // Basta 1 canestro per demo
                dist: 500,
                wind: 0,
                desc: "Perch√© tirare alla cieca? Fornisci a Gemini 2-3 esempi (Input > Output) per fargli capire lo stile esatto.",
                code: "Input: [Mail Fornitore]\nOutput: [Risposta]\n---\nInput: [Mail 2]\nOutput: [Risposta 2]\n---\nOra rispondi a questa mail seguendo lo stile."
            },
            {
                name: "CHAIN OF THOUGHT",
                req: 1,
                dist: 650,
                wind: 0,
                desc: "Per i tiri difficili, serve pianificazione. Usa la keyword 'Think Step-by-Step' per evitare errori di logica.",
                code: "Analizza i dati di vendita.\nThink Step-by-Step:\n1. Calcola il totale per brand\n2. Confronta con l'anno scorso\n3. Solo alla fine scrivi il report."
            },
            {
                name: "DELIMITERS",
                req: 2,
                dist: 600,
                wind: 1.5, // Vento forte
                desc: "Proteggi i tuoi dati dal caos! Usa i delimitatori ### per separare le istruzioni dal testo sporco.",
                code: "Estrai la data di consegna da questo testo sporco:\n###\n[Incolla qui la mail confusa]\n###"
            },
            {
                name: "FORMAT MASTER",
                req: 2,
                dist: 700,
                wind: 0.5,
                desc: "Parla come un Pro. Usa Key Words specifiche per ottenere output pronti all'uso.",
                code: "PROMPT:\nAnalizza i dati e genera:\n1. Una [TABLE] di riepilogo\n2. Un layout per [INFOGRAPHIC]\n3. Un [PYTHON SCRIPT] per i grafici."
            }
        ];

        // Bind Input
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space' && !e.repeat) this.handleInput();
        });
        // Mouse/Touch support for presentations
        this.canvas.addEventListener('mousedown', () => this.handleInput());

        // Start Loop
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    startLevel(idx) {
        document.getElementById('startModal').style.display = 'none';
        document.getElementById('levelModal').style.display = 'none';
        this.levelIdx = idx;
        this.shotsMade = 0;
        this.updateHUD();
        this.resetShot();
    }

    resetShot() {
        this.state = 'IDLE'; // Waiting for start
        this.ball.active = false;
        this.angle = 45;
        this.power = 0;
        
        const lvl = this.levels[this.levelIdx];
        this.player.x = this.hoop.x - lvl.dist;
        
        // Reset ball to player hand
        this.ball.x = this.player.x + 40;
        this.ball.y = this.player.y - 30;

        // Set Wind
        this.wind = lvl.wind ? (Math.random() * lvl.wind - (lvl.wind/2)) : 0;
    }

    handleInput() {
        if (this.state === 'IDLE') {
            this.state = 'AIM'; // Start moving arrow
        } else if (this.state === 'AIM') {
            this.state = 'POWER'; // Lock angle, start filling bar
        } else if (this.state === 'POWER') {
            this.shoot(); // Lock power, fire
        } else if (this.state === 'REPLAY') {
            this.resetShot();
        }
    }

    shoot() {
        this.state = 'FLIGHT';
        this.ball.active = true;
        
        // Physics
        const rad = (this.angle * Math.PI) / 180;
        const velocity = (this.power / 100) * 20 + 10; // Speed range
        
        this.ball.vx = Math.cos(rad) * velocity;
        this.ball.vy = -Math.sin(rad) * velocity;
    }

    update() {
        // --- INPUT ANIMATION ---
        if (this.state === 'AIM') {
            this.angle += this.angleDir;
            if (this.angle > 80 || this.angle < 20) this.angleDir *= -1;
        }
        if (this.state === 'POWER') {
            this.power += this.powerDir;
            if (this.power > 100 || this.power < 5) this.powerDir *= -1;
        }

        // --- BALL PHYSICS ---
        if (this.state === 'FLIGHT' && this.ball.active) {
            this.ball.vy += 0.4; // Gravity
            this.ball.vx -= 0.01; // Drag
            this.ball.x += this.ball.vx + this.wind;
            this.ball.y += this.ball.vy;

            // Floor
            if (this.ball.y > 550) {
                this.ball.y = 550;
                this.ball.vy *= -0.6;
                this.ball.vx *= 0.8;
                if(Math.abs(this.ball.vy) < 1) this.state = 'REPLAY'; // Fail
            }

            // Magnetic Hoop Logic (Super Easy Mode)
            const dx = this.ball.x - this.hoop.x;
            const dy = this.ball.y - this.hoop.y;
            // Big hitbox: 50px radius
            if (dx*dx + dy*dy < 2500 && this.ball.vy > 0) {
                this.success();
            }

            // Miss
            if (this.ball.x > this.width + 100) this.state = 'REPLAY';
        }

        // Particles
        this.particles.forEach((p,i) => {
            p.y += p.vy;
            p.life -= 0.02;
            if(p.life <= 0) this.particles.splice(i,1);
        });

        // Fail Reset Timer
        if(this.state === 'REPLAY') {
             // Just a simple visual delay, logic handled in draw
             setTimeout(() => { if(this.state === 'REPLAY') this.resetShot() }, 1000);
        }
    }

    success() {
        if(this.state === 'SUCCESS') return;
        this.state = 'SUCCESS';
        this.score += 100;
        this.shotsMade++;
        this.spawnConfetti();
        this.updateHUD();

        setTimeout(() => {
            const lvl = this.levels[this.levelIdx];
            if(this.shotsMade >= lvl.req) {
                this.showLevelUp();
            } else {
                this.resetShot();
            }
        }, 1500);
    }

    spawnConfetti() {
        for(let i=0; i<30; i++) {
            this.particles.push({
                x: this.hoop.x,
                y: this.hoop.y,
                vy: (Math.random() - 0.5) * 5,
                color: Math.random()>0.5 ? '#ff6900' : '#444',
                life: 1.0
            });
        }
    }

    showLevelUp() {
        const lvl = this.levels[this.levelIdx];
        document.getElementById('lvl-tech').innerText = lvl.name;
        document.getElementById('lvl-desc').innerText = lvl.desc;
        document.getElementById('lvl-code').innerText = lvl.code;
        document.getElementById('levelModal').style.display = 'flex';
    }

    updateHUD() {
        document.getElementById('scoreEl').innerText = this.score;
        document.getElementById('levelEl').innerText = (this.levelIdx + 1) + "/4";
    }

    nextLevel() {
        if(this.levelIdx + 1 < this.levels.length) {
            this.startLevel(this.levelIdx + 1);
        } else {
            alert("TRAINING COMPLETATO! Ottimo lavoro.");
            location.reload();
        }
    }

    draw() {
        // Clear
        this.ctx.clearRect(0, 0, this.width, this.height);

        // 1. BACKGROUND (Bright Day)
        const grad = this.ctx.createLinearGradient(0,0,0,600);
        grad.addColorStop(0, COLORS.sky);
        grad.addColorStop(1, '#fff');
        this.ctx.fillStyle = grad;
        this.ctx.fillRect(0,0,this.width, this.height);

        // Skyline Semplice (Grigio chiaro)
        this.ctx.fillStyle = '#e0e0e0';
        for(let i=0; i<10; i++) {
            this.ctx.fillRect(i*100, 600 - (50 + Math.sin(i)*40), 80, 200);
        }

        // 2. FLOOR
        this.ctx.fillStyle = COLORS.floor;
        this.ctx.fillRect(0, 566, this.width, 74);
        this.ctx.strokeStyle = '#ccc';
        this.ctx.beginPath();
        this.ctx.moveTo(0, 566); this.ctx.lineTo(this.width, 566);
        this.ctx.stroke();

        // 3. CROWD (Su gradinate)
        this.ctx.fillStyle = '#666';
        this.ctx.fillRect(0, 500, this.width, 66); // Bleachers
        // People Blobs
        for(let i=0; i<15; i++) {
            this.ctx.fillStyle = Math.random()>0.5 ? COLORS.hoop : '#333';
            this.ctx.beginPath();
            this.ctx.arc(50 + i*60, 490, 8, 0, Math.PI*2);
            this.ctx.fill();
            this.ctx.fillRect(42 + i*60, 500, 16, 20); // Body
        }
        // Banner
        this.ctx.fillStyle = '#fff';
        this.ctx.fillRect(200, 450, 200, 40);
        this.ctx.strokeStyle = '#333';
        this.ctx.strokeRect(200, 450, 200, 40);
        this.ctx.fillStyle = '#000';
        this.ctx.font = 'bold 14px Roboto';
        this.ctx.fillText("PROMPT LIKE A PRO", 230, 475);

        // 4. HOOP
        this.drawHoop();

        // 5. PLAYER (Draw Zally or Fallback Stickman)
        this.drawPlayer();

        // 6. BALL
        if(this.ball.active) {
            this.ctx.fillStyle = COLORS.ball;
            this.ctx.beginPath();
            this.ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2);
            this.ctx.fill();
            this.ctx.strokeStyle = '#fff';
            this.ctx.lineWidth = 2;
            this.ctx.stroke();
        }

        // 7. UI CONTROLS (BIG & VISIBLE)
        if(this.state === 'IDLE' || this.state === 'AIM' || this.state === 'POWER') {
            this.drawControls();
        }

        // 8. PARTICLES
        this.particles.forEach(p => {
            this.ctx.fillStyle = p.color;
            this.ctx.globalAlpha = p.life;
            this.ctx.fillRect(p.x, p.y, 6, 6);
            this.ctx.globalAlpha = 1.0;
        });
    }

    drawHoop() {
        const x = this.hoop.x;
        const y = this.hoop.y;
        
        // Pole
        this.ctx.fillStyle = '#555';
        this.ctx.fillRect(x+40, y, 10, 566-y);
        
        // Backboard (White w/ Orange box)
        this.ctx.fillStyle = '#fff';
        this.ctx.fillRect(x+30, y-80, 10, 90);
        this.ctx.strokeStyle = '#333';
        this.ctx.strokeRect(x+30, y-80, 10, 90);
        this.ctx.fillStyle = COLORS.hoop;
        this.ctx.fillRect(x+32, y-60, 6, 40);

        // Rim
        this.ctx.strokeStyle = COLORS.hoop;
        this.ctx.lineWidth = 4;
        this.ctx.beginPath();
        this.ctx.moveTo(x-20, y); this.ctx.lineTo(x+20, y);
        this.ctx.stroke();

        // Net
        this.ctx.strokeStyle = '#999';
        this.ctx.lineWidth = 1;
        this.ctx.beginPath();
        this.ctx.moveTo(x-20, y); this.ctx.lineTo(x-5, y+30);
        this.ctx.lineTo(x+5, y+30); this.ctx.lineTo(x+20, y);
        this.ctx.stroke();
    }

    drawPlayer() {
        const x = this.player.x;
        const y = this.player.y;

        if(this.imgLoaded) {
            this.ctx.save();
            this.ctx.translate(x+40, y+40);
            this.ctx.scale(-1, 1);
            this.ctx.drawImage(this.zallyImg, -40, -50, 80, 100);
            this.ctx.restore();
        } else {
            // PIXEL ART ZALLY FALLBACK
            this.ctx.fillStyle = '#333'; // Legs
            this.ctx.fillRect(x+10, y+50, 10, 30);
            this.ctx.fillRect(x+30, y+50, 10, 30);
            this.ctx.fillStyle = COLORS.hoop; // Shirt
            this.ctx.fillRect(x+5, y+10, 40, 40);
            this.ctx.fillStyle = '#ffccaa'; // Head
            this.ctx.fillRect(x+10, y-20, 30, 30);
            // Cap
            this.ctx.fillStyle = '#333';
            this.ctx.fillRect(x+10, y-25, 30, 8);
            this.ctx.fillRect(x+30, y-25, 15, 8); // Visor
        }
    }

    drawControls() {
        const cx = this.player.x + 50;
        const cy = this.player.y - 40;
        const radius = 80;

        // Angle Arc
        this.ctx.beginPath();
        this.ctx.strokeStyle = '#ddd';
        this.ctx.lineWidth = 15;
        this.ctx.arc(cx, cy, radius, -Math.PI/2, 0);
        this.ctx.stroke();

        // Current Aim
        const rad = -this.angle * Math.PI / 180;
        this.ctx.strokeStyle = '#333';
        this.ctx.lineWidth = 4;
        this.ctx.beginPath();
        this.ctx.moveTo(cx, cy);
        this.ctx.lineTo(cx + Math.cos(rad)*radius, cy + Math.sin(rad)*radius);
        this.ctx.stroke();

        // Power Bar Background (Verticale, pi√π visibile)
        const barX = this.player.x - 30;
        const barY = this.player.y - 80;
        this.ctx.fillStyle = '#eee';
        this.ctx.fillRect(barX, barY, 20, 100);
        this.ctx.strokeStyle = '#333';
        this.ctx.strokeRect(barX, barY, 20, 100);

        // Power Fill
        const fillH = this.power;
        this.ctx.fillStyle = this.power > 90 ? '#ff0000' : (this.power > 50 ? COLORS.hoop : '#4ade80');
        this.ctx.fillRect(barX, barY + (100-fillH), 20, fillH);

        // Help Text
        this.ctx.fillStyle = '#000';
        this.ctx.font = 'bold 16px Roboto';
        let txt = "1. TAP SPACE";
        if(this.state === 'AIM') txt = "2. TAP TO LOCK";
        if(this.state === 'POWER') txt = "3. TAP TO FIRE";
        this.ctx.fillText(txt, cx - 40, cy - 100);
    }
}

const game = new Game();

</script>
</body>
</html>
