<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zally's Hoops: 8-BIT OPS</title>
    <style>
        /* --- RETRO FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #111;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- ARCADE CABINET --- */
        #cabinet {
            position: relative;
            width: 960px;
            height: 640px;
            background: #000;
            border: 4px solid #ff6900; /* Zalando Neon */
            box-shadow: 0 0 20px #ff6900, 0 0 40px rgba(255, 105, 0, 0.4);
            border-radius: 4px;
            overflow: hidden;
        }

        /* --- CRT SCANLINES --- */
        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        canvas { display: block; image-rendering: pixelated; }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            text-shadow: 2px 2px #000;
        }

        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* --- SCREENS (MENU / LEVEL UP) --- */
        .screen {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 30;
            pointer-events: auto;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .title {
            font-size: 40px;
            color: #ff6900;
            text-shadow: 4px 4px #fff;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .subtitle {
            font-size: 14px;
            color: #4ade80; /* Green Terminal */
            margin-bottom: 40px;
            line-height: 1.8;
            max-width: 700px;
        }

        .btn {
            background: #ff6900;
            color: #fff;
            border: 4px solid #fff;
            padding: 20px 40px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 4px 4px 0px #fff;
        }
        .btn:hover { background: #ff4500; transform: translate(2px, 2px); box-shadow: 2px 2px 0px #fff; }

        .code-box {
            background: #222;
            border: 2px solid #ff6900;
            color: #0f0;
            padding: 20px;
            font-size: 10px;
            text-align: left;
            margin: 20px;
            width: 70%;
            line-height: 1.6;
        }

    </style>
</head>
<body>

<div id="cabinet">
    <div class="scanlines"></div>
    <canvas id="gameCanvas" width="960" height="640"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div>SCORE <span style="color:#ff6900" id="scoreEl">0000</span></div>
            <div id="levelEl">LEVEL 1</div>
        </div>
        <div style="padding:20px; text-align:center; font-size:10px; color:#aaa;">
            PRESS <span style="color:#fff">[SPACE]</span> TO PLAY
        </div>
    </div>

    <div id="startScreen" class="screen" style="display: flex;">
        <div class="title">ZALLY'S HOOPS<br>8-BIT OPS</div>
        <div class="subtitle">
            MISSION: MASTER THE ART OF PROMPTING.<br><br>
            CONTROLS (3-TAP SYSTEM):<br>
            1. SPACE: START AIM<br>
            2. SPACE: LOCK & POWER<br>
            3. SPACE: FIRE!
        </div>
        <button class="btn blink" onclick="game.startLevel(0)">INSERT COIN</button>
    </div>

    <div id="levelScreen" class="screen">
        <div class="title" style="color:#4ade80">LEVEL CLEARED!</div>
        <div class="subtitle" id="lvlDesc">...</div>
        <div class="code-box" id="lvlCode">...</div>
        <button class="btn" onclick="game.nextLevel()">NEXT LEVEL >></button>
    </div>

</div>

<script>
/**
 * ZALLY'S HOOPS - ARCADE EDITION
 * Style: 8-Bit, Neon, CRT
 */

const COLORS = {
    orange: '#ff6900',
    white: '#ffffff',
    black: '#000000',
    skyTop: '#111',
    skyBot: '#223',
    green: '#4ade80'
};

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        // Disable smoothing for pixel art look
        this.ctx.imageSmoothingEnabled = false; 

        // Load Asset (Fallback implemented)
        this.zallyImg = new Image();
        this.zallyImg.src = 'zally-basket.png';
        this.imgLoaded = false;
        this.zallyImg.onload = () => { this.imgLoaded = true; };

        // State
        this.state = 'MENU';
        this.levelIdx = 0;
        this.score = 0;
        this.shotsMade = 0;

        // Entities
        this.ball = { x:0, y:0, vx:0, vy:0, r:12, active:false };
        this.hoop = { x:800, y:250 };
        this.player = { x:100, y:500 };

        // Input
        this.angle = 45;
        this.angleDir = 1;
        this.power = 0;
        this.powerDir = 2;

        // FX
        this.particles = [];
        this.floaters = [];
        this.shake = 0;

        // Levels
        this.levels = [
            {
                name: "LVL 1: FEW-SHOT",
                req: 1, 
                dist: 500, 
                wind: 0,
                desc: "GEMINI NEEDS EXAMPLES! DON'T JUST ASK. SHOW IT HOW IT'S DONE.",
                code: "PROMPT:\n'ACT AS AN OPS EXPERT.\nEXAMPLE 1: [DATA] -> [REPORT]\nEXAMPLE 2: [DATA] -> [REPORT]\nNOW DO THIS: [NEW DATA]'"
            },
            {
                name: "LVL 2: CHAIN OF THOUGHT",
                req: 1, 
                dist: 650, 
                wind: 0,
                desc: "COMPLEX TASK? FORCE LOGIC! USE THE MAGIC WORDS: 'THINK STEP-BY-STEP'.",
                code: "PROMPT:\n'ANALYZE THIS INVOICE.\n1. EXTRACT TOTALS\n2. COMPARE WITH PO\n3. FLAG DISCREPANCIES\nTHINK STEP-BY-STEP.'"
            },
            {
                name: "LVL 3: DELIMITERS",
                req: 2, 
                dist: 600, 
                wind: 1.5,
                desc: "DIRTY DATA DETECTED! USE ### TO SHIELD YOUR INSTRUCTIONS.",
                code: "PROMPT:\n'ANALYZE ONLY TEXT BETWEEN ###\n###\n[MESSY EMAIL THREAD]\n###\nEXTRACT DELIVERY DATES.'"
            },
            {
                name: "LVL 4: KEYWORDS",
                req: 2, 
                dist: 700, 
                wind: 0.5,
                desc: "SPEAK THE CODE! USE [FORMATS] TO GET PERFECT OUTPUTS.",
                code: "PROMPT:\n'GENERATE A [TABLE] OF SKUS.\nCREATE A [PYTHON SCRIPT] FOR ANALYSIS.\nWRITE A SUMMARY IN [BULLET POINTS].'"
            }
        ];

        // Global Key Listener
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space') {
                e.preventDefault(); // Stop scrolling
                if(this.state === 'MENU') this.startLevel(0);
                else if(this.state === 'LEVEL_UP') this.nextLevel();
                else this.handleInput();
            }
        });

        // Loop
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    startLevel(idx) {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('levelScreen').style.display = 'none';
        
        this.levelIdx = idx;
        this.shotsMade = 0;
        this.updateHUD();
        this.resetShot();
    }

    resetShot() {
        this.state = 'IDLE'; 
        this.ball.active = false;
        this.angle = 45;
        this.power = 0;
        
        const lvl = this.levels[this.levelIdx];
        this.player.x = this.hoop.x - lvl.dist;
        this.ball.x = this.player.x + 40;
        this.ball.y = this.player.y - 10;

        this.wind = lvl.wind ? (Math.random() * lvl.wind - (lvl.wind/2)) : 0;
    }

    handleInput() {
        if(this.state === 'IDLE') this.state = 'AIM';
        else if(this.state === 'AIM') this.state = 'POWER';
        else if(this.state === 'POWER') this.shoot();
        else if(this.state === 'REPLAY') this.resetShot();
    }

    shoot() {
        this.state = 'FLIGHT';
        this.ball.active = true;
        
        const rad = (this.angle * Math.PI) / 180;
        const speed = (this.power / 100) * 20 + 12; // High Speed Arcade Feel
        
        this.ball.vx = Math.cos(rad) * speed;
        this.ball.vy = -Math.sin(rad) * speed;
    }

    update() {
        if(this.state === 'AIM') {
            this.angle += this.angleDir * 1.5;
            if(this.angle > 80 || this.angle < 20) this.angleDir *= -1;
        }
        if(this.state === 'POWER') {
            this.power += this.powerDir * 2;
            if(this.power > 100 || this.power < 10) this.powerDir *= -1;
        }

        if(this.state === 'FLIGHT' && this.ball.active) {
            this.ball.vy += 0.5; // Gravity
            this.ball.x += this.ball.vx + this.wind;
            this.ball.y += this.ball.vy;

            // Floor
            if(this.ball.y > 560) {
                this.ball.y = 560;
                this.ball.vy *= -0.6;
                this.ball.vx *= 0.8;
                if(Math.abs(this.ball.vy) < 1) this.fail("MISS");
            }

            // Magnetic Hoop (Arcade Logic)
            const dx = this.ball.x - this.hoop.x;
            const dy = this.ball.y - this.hoop.y;
            if(dx*dx + dy*dy < 2000 && this.ball.vy > 0) {
                this.success();
            }

            if(this.ball.x > 960) this.fail("AIRBALL");
        }

        // FX
        this.particles.forEach((p,i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            if(p.life<=0) this.particles.splice(i,1);
        });
        
        this.floaters.forEach((f,i) => {
            f.y -= 2; f.life -= 1;
            if(f.life<=0) this.floaters.splice(i,1);
        });

        if(this.shake > 0) this.shake *= 0.8;
        if(this.shake < 0.5) this.shake = 0;
    }

    fail(reason) {
        if(this.state === 'REPLAY') return;
        this.state = 'REPLAY';
        this.floaters.push({txt: reason, x:this.ball.x, y:this.ball.y, life:30, color:'#f00'});
        setTimeout(() => { if(this.state==='REPLAY') this.resetShot() }, 1000);
    }

    success() {
        if(this.state === 'SUCCESS') return;
        this.state = 'SUCCESS';
        this.score += 500;
        this.shotsMade++;
        this.shake = 10;
        
        // Pixel Explosion
        for(let i=0; i<20; i++) {
            this.particles.push({
                x: this.hoop.x, y:this.hoop.y,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                color: Math.random()>0.5 ? COLORS.orange : '#fff',
                life: 1.0
            });
        }
        this.floaters.push({txt: "SWISH!", x:this.hoop.x, y:this.hoop.y-50, life:60, color: COLORS.green});
        
        this.updateHUD();

        setTimeout(() => {
            const lvl = this.levels[this.levelIdx];
            if(this.shotsMade >= lvl.req) {
                this.state = 'LEVEL_UP';
                this.showLevelUp();
            } else {
                this.resetShot();
            }
        }, 1500);
    }

    showLevelUp() {
        const lvl = this.levels[this.levelIdx];
        document.getElementById('lvlDesc').innerText = lvl.desc;
        document.getElementById('lvlCode').innerText = lvl.code;
        document.getElementById('levelScreen').style.display = 'flex';
    }

    nextLevel() {
        if(this.levelIdx + 1 < this.levels.length) {
            this.startLevel(this.levelIdx + 1);
        } else {
            alert("ALL LEVELS CLEARED! SCORE: " + this.score);
            location.reload();
        }
    }

    updateHUD() {
        document.getElementById('scoreEl').innerText = this.score.toString().padStart(4,'0');
        document.getElementById('levelEl').innerText = this.levels[this.levelIdx].name;
    }

    draw() {
        this.ctx.save();
        
        // Shake
        if(this.shake>0) {
            this.ctx.translate(Math.random()*this.shake - this.shake/2, Math.random()*this.shake - this.shake/2);
        }

        this.ctx.clearRect(0,0,960,640);

        // 1. SKYLINE (8-BIT)
        this.ctx.fillStyle = '#050510';
        this.ctx.fillRect(0,0,960,640);
        
        // Moon
        this.ctx.fillStyle = '#fff';
        this.ctx.fillRect(800, 50, 40, 40);

        // Buildings (Rectangles)
        this.ctx.fillStyle = '#1a1a2e';
        for(let i=0; i<15; i++) {
            let h = 100 + Math.sin(i*99)*50;
            this.ctx.fillRect(i*70, 600-h, 60, h);
            // Windows
            this.ctx.fillStyle = Math.random()>0.9 ? COLORS.orange : '#111';
            this.ctx.fillRect(i*70+10, 600-h+10, 10, 10);
            this.ctx.fillStyle = '#1a1a2e';
        }

        // 2. FLOOR
        this.ctx.fillStyle = '#222';
        this.ctx.fillRect(0, 560, 960, 80);
        this.ctx.strokeStyle = COLORS.orange;
        this.ctx.beginPath();
        this.ctx.moveTo(0,560); this.ctx.lineTo(960,560);
        this.ctx.stroke();

        // 3. HOOP (Pixel Art Style)
        const hx = this.hoop.x; const hy = this.hoop.y;
        this.ctx.fillStyle = '#444'; this.ctx.fillRect(hx+40, hy, 10, 560-hy); // Pole
        this.ctx.fillStyle = '#fff'; this.ctx.fillRect(hx+30, hy-80, 10, 90); // Backboard
        this.ctx.fillStyle = COLORS.orange; this.ctx.fillRect(hx+32, hy-60, 6, 40); // Target
        this.ctx.strokeStyle = COLORS.orange; this.ctx.lineWidth = 4;
        this.ctx.beginPath(); this.ctx.moveTo(hx-20, hy); this.ctx.lineTo(hx+20, hy); this.ctx.stroke(); // Rim

        // 4. PLAYER (ZALLY 8-BIT)
        if(this.imgLoaded) {
            this.ctx.save();
            this.ctx.translate(this.player.x+40, this.player.y+40);
            this.ctx.scale(-1, 1);
            this.ctx.drawImage(this.zallyImg, -40, -50, 80, 100);
            this.ctx.restore();
        } else {
            const px = this.player.x; const py = this.player.y;
            this.ctx.fillStyle = COLORS.orange; this.ctx.fillRect(px, py, 40, 60); // Body
            this.ctx.fillStyle = '#ffccaa'; this.ctx.fillRect(px+5, py-20, 30, 20); // Head
            this.ctx.fillStyle = '#000'; this.ctx.fillRect(px, py-25, 40, 5); // Hat
        }

        // 5. BALL (Pixel Circle)
        if(this.ball.active) {
            this.ctx.fillStyle = COLORS.orange;
            this.ctx.beginPath(); this.ctx.arc(this.ball.x, this.ball.y, 12, 0, Math.PI*2); this.ctx.fill();
        }

        // 6. UI (Aim Arrow & Power)
        if(this.state === 'AIM' || this.state === 'POWER') {
            const ax = this.player.x + 40; const ay = this.player.y - 20;
            const rad = -this.angle * Math.PI / 180;
            const len = 80;
            
            // Dotted Line
            this.ctx.strokeStyle = '#fff';
            this.ctx.lineWidth = 4;
            this.ctx.beginPath(); this.ctx.moveTo(ax,ay); 
            this.ctx.lineTo(ax+Math.cos(rad)*len, ay+Math.sin(rad)*len);
            this.ctx.stroke();

            // Power Bar
            if(this.state === 'POWER') {
                this.ctx.fillStyle = '#fff'; this.ctx.fillRect(ax-50, ay-80, 100, 20);
                this.ctx.fillStyle = COLORS.orange; this.ctx.fillRect(ax-50, ay-80, this.power, 20);
            }
        }

        // 7. PARTICLES & TEXT
        this.particles.forEach(p => {
            this.ctx.fillStyle = p.color;
            this.ctx.fillRect(p.x, p.y, 8, 8); // Big pixels
        });

        this.floaters.forEach(f => {
            this.ctx.fillStyle = f.color;
            this.ctx.font = '20px "Press Start 2P"';
            this.ctx.fillText(f.txt, f.x, f.y);
        });

        this.ctx.restore();
    }

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(this.loop);
    }
}
